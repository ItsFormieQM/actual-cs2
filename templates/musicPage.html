<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Musical Area!</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
body {
    background: #0b0c10;
    color: white;
    font-family: "Press Start 2P", monospace;
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.container {
    position: relative;
    width: 420px;
    padding: 20px;
    background: linear-gradient(145deg, #1c1c2a 0%, #3b3b5a 100%);
    border: 4px solid #8f00ff;
    border-radius: 0px;
    box-shadow: 0 0 25px #8f00ff, 0 0 50px #8f00ff inset;
    animation: float 3s ease-in-out infinite;
    text-align: center;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

h2 { margin: 5px 0; }

.menu-box {
    border: 2px solid #8f00ff;
    padding: 10px;
    height: 200px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    background: rgba(50,0,70,0.3);
    border-radius: 0px;
}

.option {
    display: flex;
    align-items: center;
    padding: 6px 10px;
    transition: all 0.2s;
    color: white;
}

.option .heart {
    width: 16px;
    height: 16px;
    margin-right: 6px;
    image-rendering: pixelated;
    vertical-align: middle;
    visibility: hidden;
}

.option.selected .heart { visibility: visible; }

.option .title {
    display: inline-block;
    max-width: 340px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.audio-controls {
    margin-top: 15px;
}

input[type=range] { width: 100px; }

.disclaimer {
    margin-top: 15px;
    font-size: 16px;
    color: #ff77ff;
}

.now-playing {
    margin-top: 10px;
    font-size: 16px;
    color: #ffff00;
    min-height: 20px;
    width: 100%;
    overflow: hidden;
    position: relative;
    border-top: 1px solid #8f00ff;
    border-bottom: 1px solid #8f00ff;
    padding: 2px 0;
}

.now-playing span {
    position: absolute;
    white-space: nowrap;
    will-change: transform;
    left: 0;
}

button { display:none; } /* hide WASD/Z buttons */
</style>
</head>
<body>

<div class="container">
    <h2>Toby Fox Music</h2>

    <div class="menu-box" id="menuBox">
        <div class="menu" id="musicMenu">
            <!-- OST folders or music files will be populated here -->
        </div>
    </div>

    <div class="audio-controls">
        <div class="now-playing" id="nowPlaying"><span>Now Playing: None</span></div>
        <audio id="bgm" controls autoplay loop>
            <source id="track" src="" type="audio/ogg">
        </audio>
        <div style="margin-top:10px;">
            <label>Volume</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.3">
            <label>Loop</label>
            <input type="checkbox" id="loopCheckbox" checked>
        </div>
    </div>

    <div class="disclaimer">
        Press <strong>X</strong> to go back / exit
    </div>
</div>

<script>
const bgm = document.getElementById("bgm");
const track = document.getElementById("track");
const volumeSlider = document.getElementById("volumeSlider");
const loopCheckbox = document.getElementById("loopCheckbox");
const nowPlaying = document.getElementById("nowPlaying");
const nowPlayingSpan = nowPlaying.querySelector("span");

const menuBox = document.getElementById("menuBox");
const musicMenu = document.getElementById("musicMenu");

let index = 0;
let currentPlayingIndex = null;

let state = "ost-select"; // "ost-select" or "music"
let currentBranch = null;
let options = [];

// Audio for navigation
const moveSFX = new Audio("/static/sfx/snd_menumove.wav");
moveSFX.volume = 0.5;
const confirmSFX = new Audio("/static/sfx/snd_select.wav");
confirmSFX.volume = 0.5;

// Example OST folders from Flask
const ostFolders = {{ ost_folders|tojson }};
const musicLibrary = {{ music_library|tojson }};

// Helper: populate menu
function populateMenu(items, isFiles=false){
    musicMenu.innerHTML = "";
    options = [];
    items.forEach(name=>{
        const div = document.createElement("div");
        div.classList.add("option");
        if(isFiles){
            div.dataset.file = name;
            div.dataset.branch = currentBranch;
            div.innerHTML = `<img class="heart" src="/static/sprites/redsoul.png"><span class="title" title="${name}">${name.replace(/\.\w+$/,'')}</span>`;
        } else {
            div.dataset.branch = name;
            div.innerHTML = `<img class="heart" src="/static/sprites/redsoul.png"><span class="title">${name}</span>`;
        }
        musicMenu.appendChild(div);
        options.push(div);
    });
    index = 0;
    currentPlayingIndex = null;
    updateSelection();
}

// Update selection and scroll
function updateSelection(playSound=false){
    options.forEach(o=>o.classList.remove("selected"));
    options.forEach((o,i)=>{
        o.querySelector(".heart").style.visibility = (i===index) ? "visible" : "hidden";
    });
    options[index].classList.add("selected");
    if(playSound){ moveSFX.currentTime=0; moveSFX.play().catch(()=>{}); }

    const optionHeight = options[0]?.offsetHeight || 0;
    const visibleCount = 5;
    let topIndex = Math.max(0, index - visibleCount + 1);
    const scrollTop = topIndex * optionHeight;
    menuBox.scrollTo({ top: scrollTop, behavior: "smooth" });
}

// Play music
function playMusic(file){
    track.src = "/static/music/" + currentBranch + "/" + file;
    bgm.load();
    bgm.play().catch(()=>{});

    if(currentPlayingIndex!==null) options[currentPlayingIndex].style.color = "white";
    options[index].style.color = "yellow";
    currentPlayingIndex = index;

    startMarquee("Now Playing: " + file.replace(/\.\w+$/,''));
}

// Marquee for now playing
let marqueeAnim = null;
function startMarquee(text){
    cancelAnimationFrame(marqueeAnim);
    nowPlayingSpan.textContent = text;
    let pos = 0;
    const containerWidth = nowPlaying.offsetWidth;
    const textWidth = nowPlayingSpan.offsetWidth;

    function step(){
        pos -= 1;
        if(pos < -textWidth) pos = containerWidth;
        nowPlayingSpan.style.transform = `translateX(${pos}px)`;
        marqueeAnim = requestAnimationFrame(step);
    }
    if(textWidth>containerWidth) step();
    else nowPlayingSpan.style.transform="translateX(0)";
}

// Handle keyboard input
document.addEventListener("keydown", e=>{
    if(options.length===0) return;

    if(e.key==="w" || e.key==="ArrowUp"){ index=(index-1+options.length)%options.length; updateSelection(true); }
    if(e.key==="s" || e.key==="ArrowDown"){ index=(index+1)%options.length; updateSelection(true); }
    if(e.key==="z"){
        confirmSFX.currentTime=0;
        confirmSFX.play().catch(()=>{});
        const selected = options[index];
        if(state==="ost-select"){
            currentBranch = selected.dataset.branch;
            state="music";
            const files = musicLibrary[currentBranch] || [];
            populateMenu(files,true);
        } else if(state==="music"){
            const file = selected.dataset.file;
            playMusic(file);
        }
    }
    if(e.key==="x"){
        if(state==="music"){
            state="ost-select";
            populateMenu(ostFolders,false);
        } else {
            window.location.href="/";
        }
    }
});

// Volume & loop controls
volumeSlider.addEventListener("input", ()=>{ bgm.volume=parseFloat(volumeSlider.value); });
loopCheckbox.addEventListener("change", ()=>{ bgm.loop=loopCheckbox.checked; });

// Initial menu: OST selection
populateMenu(ostFolders,false);
</script>

</body>
</html>
